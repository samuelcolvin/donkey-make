#!/usr/bin/env donk
lint:
  run:
  - cargo fmt --version
  - cargo fmt --all -- --check
  - cargo clippy --version
  - cargo clippy -- -D warnings
  description: 'run both cargo fmt and clippy in "check" mode'

test:
  run:
  - cargo test
  - env/bin/python -m pytest tests/
  description: run tests

cargo-test-combine:
  run:
  - cargo test -q --no-run
  - .kcov/kcov .coverage/cargo_test --exclude-pattern=/.cargo,/usr/lib --verify ./target/debug/donkey_make-9ab6591b78d7eea7

all:
  run:
  - +lint
  - +test
  description: run lint and test

format:
  - cargo fmt

build:
  run:
  - rm -rf target/release/
  - export TRAVIS_COMMIT="$(git rev-parse HEAD)"
  - cargo build --release
  - cp target/release/donkey-make donk
  description: build a release version of the donkey-make binary "donk" and copy into this directory

build-kcov:
  run:
  - |
   @if test -f "./.kcov/kcov"; then
   @echo "kcov already exist"
   exit
   @fi
  - mkdir -p .kcov
  - cd .kcov
  - curl -L https://github.com/SimonKagstrom/kcov/archive/v36.tar.gz > kcov.tar.gz
  - tar xzf kcov.tar.gz
  - cd kcov-36
  - mkdir build
  - cd build
  - cmake ..
  - make
  - mv src/kcov ../../
  - cd ../..
  - rm -r kcov.tar.gz kcov-36
  description: download and build kcov
